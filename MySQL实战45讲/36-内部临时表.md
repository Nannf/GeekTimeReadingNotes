#### 前言

书接上回，我们有join提到的临时表，然后介绍了临时表的特性与使用场景。

使用场景多见于如何使用临时表对一些查询进行优化。是我们外在的显示的使用临时表。

下面需要对mysql内部使用临时表的union和group by进行分析，看看它们是如何使用的。





#### union

为了定量分析，建表如下

```mysql

create table t1(id int primary key, a int, b int, index(a));
delimiter ;;
create procedure idata()
begin
  declare i int;

  set i=1;
  while(i<=1000)do
    insert into t1 values(i, i, i);
    set i=i+1;
  end while;
end;;
delimiter ;
call idata();
```

执行语句

```mysql
(select 1000 as f) union (select id from t1 order by id desc limit 2);
```

**union的语义就是取两个子查询结果的并集**

**并集的含义就是两个集合加起来，重复的行只保留一行**

查询这个sql的执行计划如下：

![img](https://static001.geekbang.org/resource/image/40/4e/402cbdef84eef8f1b42201c6ec4bad4e.png)

- 第2行的key 是PRIMARY表示第二个子句使用了索引id
- 第三行的extra字段的using temporary表示使用了内部临时表。



语句的执行流程如下：

1. 创建一个内存临时表，表中只有一个整形字段f，并且f是主键字段（这个是哪看出来的，还是机制就是如此）
2. 执行第一个子查询，获取到1000，存入临时表中
3. 执行第二个子查询
   1. 首先拿到id=1000，往临时表中插入的时候，主键冲突，插不进去
   2. 然后拿999 成功插入
4. 从临时表中取结果数据

![img](https://static001.geekbang.org/resource/image/5d/0e/5d038c1366d375cc997005a5d65c600e.jpg)

我们知道union是要对结果去重的，去重的做法就是把返回的所有字段定义为一个唯一键；

