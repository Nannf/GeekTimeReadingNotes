#### 前言

”饮鸩止渴“，渴虽解，人已死。



通读一遍，作者举出了一些常见的数据库性能下降的场景，并给出了一些解决方案。

本文一遍阅读下来感受是有压力，文章中都是实际存在的场景，我把自己代入到场景下发现自己好像脑袋一片空白，数据量都挺大，问题也都挺严重，百度似乎也没用。

感觉到这一讲开始就已经是实战篇了，需要查漏补缺，真正的用起来，加油。



#### 背景

- 业务高峰期
- mysql服务器没有响应
- 短期内，临时性提升性能
- 有损的



##### 短连接风暴

###### 问题的原因

- 正常的短连接是，客户端和服务器建立连接，执行很少的语句之后就断开连接，然后使用时重复上面的步骤
- 短连接的问题就是这个建立连接的过程，除了三次握手之外，还要做登录权限判断等，比较耗时。
  - 耗时的影响在同时请求的数量多了之后慢慢显现
  - 因为这些操作都是cpu调度执行的，如果cpu执行了这个操作，就会减少实际执行的查询的操作
  - 基于上面的分析，我们知道数据库设置了一个最大连接数的概念，就是为了让数据库尽可能的为更多的提供服务，却不至于让自己的拥塞住。
  - 但是这个就有问题了，就是这个最大连接数是一定的，但是如果同时请求的一旦多起来，那么就会连接不上，此时对客户端而言，直观的现象就是数据库服务不可用。

###### 问题的解决措施

1. 增大数据库连接数量
   - 正如我们在上文分析的，这个会适得其反，如果服务器资源使用率（cpu，磁盘等）不高的情况下，会有效果，但是更多的时候，增加了连接数量，而cpu等硬件不同步升级，在cpu时间片轮转调度的情况下，会有更少的时间被分配给那些真正的sql执行语句，这会使那些连接的释放更加缓慢，久而久之，就会发现新增的连接数也被占满了，然后继续加连接数，继续占用系统资源，这一恶性循环。
2. 把那些占着连接不使用的连接给kill 掉
   - 有风险，风险主要体现在，有的连接已经开启了事务，然后在等待，有些没有，那些开启事务的连接，一旦被kill，就会回滚之前的操作，这个对业务的影响比较大
   - 如果是那些没有事务的连接，但是我们不能保证客户端在每次使用连接之前都会去判断连接是否还存在，如果不去判断的话，你把它的连接给kill了。会影响这个业务的正常使用。
3. 减少连接的处理过程，重启数据库，把跳过权限验证的开关打开，这样就减少了连接过程中的一些额外操作，但是风险巨大，不推荐使用。