### 一条更新语句是如何执行的

#### 先用上一张的知识来描述大致的流程

1. 用mysql命令连接mysql服务器，连接器模块校验用户名密码，通过后给该连接附上权限；
2. 不是查询语句，分析器模块进行词法分析，语法分析，语义分析，然后通过优化器模块，选择索引等生成执行计划；
3. 执行器根据执行计划，调用存储引擎的接口完成操作。

这边遗漏一部分，就是因为是更新操作，所以会把这个表的所有查询缓存全部清空。



因为我们存在一些误操作，或者我就是想回溯到某个时间点，去查看那个时间点的数据库的状态，就需要一个文件去记录这就是**binlog**;

因为每次更新都写随机i/o比较慢，所以我们有了**redolog**,写redolog的时候，也是写磁盘，不过是顺序i/o。会比随机i/o快很多。

##### 关于redolog的几个关键点

- redolog的大小是固定的，是可配的，类似于循环队列，当空间用完之后，会同步一部分数据到磁盘上，然后把这部分空间释放出来接着记录；
- 更新时是先更新redolog，再更新内存，更新内存的原因此时redolog还没有实际的更新到记录里，所以我们再查询的时候查的就不会是实际在磁盘上的记录，而应该是一个缓存的，比如内存中。



mysql在更新的时候实际做的操作是：

1. 先把修改内容在redolog中记录，然后把redo变成prepare状态；
2. 再在bin中记录，bin和redo是有一个XID进行关联的；
3. 最后把redolog变成commit状态，提示客户端更新完成；

假设mysql服务器在更新的时候发生了异常，宕机了，我们来分析不同的宕机时刻会不会出现不一致的情况，我说的不一致时mysql服务器重启的时候，是会去检查所有的redolog的状态，然后根据redolog修改数据库的状态，还有一个就是数据库根据bin去恢复数据库，这二者恢复得到的数据库状态应该是一致的。

binlog只有我们需要的时候才会使用，而redolog是mysql启动时自己会去检查，上一次运行结束之后有没有没有处理完的情况。为什么需要去检查呢？因为程序宕机了，内存没有了，如果查询的话，就是基于真实的数据查询的了，所以必须把之前临时记在redolog里面的所有记录全部同步到磁盘上。



如果服务器是在第一步完成的时候宕机了，当重启的时候，这个prepare的状态的redo需不需要填在账本中呢？如果我们填了会怎么样，我们发现binlog还没有写，如果我们需要用binlog还原系统，就会和实际的不一致；

所以程序启动的时候如果发现redolog在prepare状态，它会紧接着去查询binlog，查询的过程我们可以简单的理解为根据XID来查找，如果没有找到，就把这条记录删去；

如果找到了，就会执行这个redolog的内容。



##### 需要补充的点

1. binlog和redolog中存储的到底是什么？

   - binlog中存储的是逻辑操作;[^作者注1]，有两种模式：

     - 一种是statement，这种记录的就是sql语句；
     - 一种是row，这种会记录行的内容，记录两条，更新前和更新后的都有。
   - redolog存放的是物理操作，比如我对哪个数据页做了哪些改动。

     

2. binlog的使用场景

   1. 恢复数据
      - 具体场景是我有一次误删操作，如何恢复数据
        - 假如数据库有备份的话，我们找到数据库误删之前的最近一次备份的全量备份；
        - 从备份的时间点开始把binlog全取出来，然后一直执行到误删前的那一刻
        - 后面的数据要跟业务系统一起看，恢复的可能性比较小，因为后续的处理是基于一份错误的数据，常见的错误就是主键冲突之类的。
   2. 扩容的时候
      - 具体场景：再多搭建一些备库来增加系统的读能力
        - 常见做法就是全量备份加上应用binlog



[^作者注1]: 逻辑是指放到别的数据库大家也可以使用，因为都是这个逻辑；物理是指跟我的物理结构相关，别的不理解。