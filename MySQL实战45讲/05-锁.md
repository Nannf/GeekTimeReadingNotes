## 锁

### 出现的背景

数据库是共享的资源，会有多个线程同时对其访问。多线程并发访问的时候一定需要同步吗？是需要的，比如我在执行`select Id from T where age =14`的时候，同时`alter table T drop column age`,如果我不加同步操作，那我在查询语句执行的过程中，age字段被删除了，这个sql就会执行报错。这个问题不是无解。因为mysql默认的事务隔离级别是可重复读，在我们执行查询之前，其实已经创建了一个视图，你对表结构的改动，跟我的本次查询没啥关系。我们考虑的时候可以不考虑这个隔离级别，因为不是所有的存储引擎都支持事务。

那对我的查询语句来说，如果我先于更改表结构的语句先执行，那么我理所应当在查询结束前你才能改我的表结构。

 其实这个也是看我们对我们的数据库再使用的时候有什么期望。并没有一个明确的答案。

比如我想让我的数据库定格在某一个时间点，我要做全表备份。你需要提供一个机制。这个机制就是锁。

为啥备份一定要在一个确定的时间点呢？因为备份的表之间可能存在逻辑上的一致性，比如转账，A扣钱，B加钱，这两个虽然是一个事务，但是如果不加锁控制就会导致逻辑上的不一致性。

这是我们的一个期望。这种整个数据库都只能读的锁叫全局锁。开启的方式就是FTWRL(FLUSH TABLE WITH READ LOCK)。

当然是否让数据只能读，或者只能读的目的是为了逻辑上的一致性，有没有别的实现方式了呢？有的

一个是 改变一个全局只读标识为true。一个是使用支持事务的一致性读的隔离级别。

这两个都有自己的应用场景。前者的问题是这个参数不止会用在控制全局已读上，代价比FTWRL更大。后者有个要求就是所有的表都使用支持这种事务隔离级别的引擎。



#### 表锁