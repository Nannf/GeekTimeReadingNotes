#### 前言

本文主要探究的问题是，在一主一备多从的场景下的读写分离带来的问题。

问题的原因主要是过期读，即读到的数据不是最新的。

发生的场景是因为只有主库才有写的权限，但是读不一定是从主库读，主库和从库之间的数据同步是有时差的，我们如果在这个时间差中读取了从库的数据，那么就会产生过期读。



#### 基础架构

##### 客户端做请求转发的架构

![img](https://static001.geekbang.org/resource/image/13/aa/1334b9c08b8fd837832fdb2d82e6b0aa.png)

- 客户端的连接信息维护在客户端
- 架构简单，出问题好排查
- 需要了解数据库的连接信息，如果数据库发生主备切换，客户端需要及时的感知，并调整相关的连接信息
- 这并不意味着业务代码需要感知这些，会单独分离一层出来管理连接信息，如ZooKeeper

##### 由专门的代理层来进行转发的架构

![img](https://static001.geekbang.org/resource/image/1b/45/1b1ea74a48e1a16409e9b4d02172b945.jpg)

- 我觉得这边的client客户端是真正意义上的业务代码，上一个的客户端相当于客户端+proxy
- 架构复杂
- proxy需要做高可用
- 是现在的发展趋势，但是还要量力而行



#### 解决过期读的几个方案

##### 强制走主库