### 一条SQL查询语句是如何执行的？

1. 我们先登陆上mysql服务器
   - `mysql -h$ip -P$port -u$user -p`
2. 运行mysql 命令和mysql服务器连接，这一步主要是TCP三次握手，然后校验用户名密码，通过后从权限表中查询出用户权限作为连接属性一直持续到连接断开；负责处理这一步的模块是**连接器**模块；
3. 连接上之后，先把查询语句作为key到查询缓存中看能否获取到之前的查询结果，因为一旦对这个表进行改动，这个表的所有查询缓存都会被删除，所以只要查询的到，那一定是最新的，但是mysql8.0之后的版本移除了这个功能，这一步是**查询缓存模块**；
   - 可以使用查询缓存优化的模块，我们亦可以使用redis来缓存，而且做的更好
4. 如果没有查询到，程序会对查询sql进行编译，主要就是词法分析，语法分析，语义分析，比如识别到select，就知道这是一个查询语句，如果一切正常的话，会把from的后面解析为表，把select 和 from 之间的定义为列数据，这一步有个语义分析，如果查询的表不存在，或者查询的字段在表中不存在，会在这一步直接返回，这一步是**分析器模块**。
5. 分析完成后，按道理就可以进行查询了，但是出于性能考虑，需要对查询索引进行选择等等，这一步是**优化器模块**
6. 优化器模块生成了最终的执行计划，**执行器**会调用**存储引擎**对外提供的接口，就查询而言，会调用查询接口，一次获取出一些记录，然后和查询条件进行比对，把满足条件的加入返回结果集中。



上面是对整个流程有了一个大致的描述，下面补充一些细节。



### 架构图

![img](https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png)

- mysql服务器分server层，和存储引擎层
  - 分层时，存储引擎只对外暴露读写数据的接口
  - server层负责根据存储引擎暴露的读写接口进行一些功能的封装
    - 所有跨存储引擎的视图，存储过程等都由server层实现
- 分析器到查询缓存的那条线
  - 是查询缓存还存在的时候，把查询结果写查询缓存的操作



### 连接器

#### 连接器的权限控制

- 我们在后续的章节知道，权限是分多个级别的，如果修改的是全局权限，那么所有的已有连接都是感知不到的。
- 如果是db权限
  - 如果当前连接不是在db模式下创建的(use db)，那么是会被直接影响的
  - 如果这个用户关于这个数据库的权限，在被修改前，这个用户已经在这个db模式下，那么是不会受影响的
- 如果是表和列权限
  - 是会直接影响到现有的所有链接。
- 关于修改哪些权限语句之后，已有的连接会直接受到影响
  - 如果当前连接已经在那个模式下，就不会
    - 因为全局权限是最大的，所以修改全局权限不会影响到任何连接
    - 修改库权限，只有在那个库下面的连接不会收到影响
    - 因为表和列已经是最小的级别了，不包含下一级了，所以，所有的连接都会收到影响。



#### 长连接与短连接

**长连接**： 是一种行为，如果我执行查询完，就断开连接，下次执行查询的时候，再重新建立连接这种行为就叫做短连接，与之对应的就是长连接。

- 连接器负责管理客户端的连接
- 连接的建立比较耗时
  - 之前看到一个文章通过抓包，发现tcp三次握手耗时占整个查询的很大一部分
- 推荐使用长连接，即我们很多次的操作，都使用一个连接来完成，但是我们知道，执行操作是需要消耗内存的，内存是连接的一个成员变量，即长连接会累积每次操作需要的内存，这部分的内存如果不手动释放，会一直累积到连接断开，这会导致OOM隐患
  - 定期断开，程序中负责连接的一块，比如一天断一次，或者知道某种类型的操作会导致内存的大量消耗，再执行完成后，直接断开
    - 这个定期可以根据使用状况进行调整。
  - 如果是5.7版本之上，可以再执行完大查询后，使用`mysql_reset_connection`复原连接的状态到刚申请时
    - 免去了重新建立连接的消耗。





#### rows_examined和引擎扫描行数

rows_examined是server层调用引擎层获取数据接口的次数；

一次调用引擎至少扫描一行。

rows_examined <= 引擎扫描行数。





### 思考

> 我给你留一个问题吧，如果表 T 中没有字段 k，而你执行了这个语句 select * from T where k=1, 那肯定是会报“不存在这个列”的错误： “Unknown column ‘k’ in ‘where clause’”。你觉得这个错误是在我们上面提到的哪个阶段报出来的呢？



```txt
答： 首先不是连接器。
连接器之后是分析器，分析器包括词法分析，语法分析，语义分析。
语义分析就涉及到查找的表以及表中的字段是否存在；
故而是分析器阶段爆出来的。

为什么不是执行器呢？
执行器已经在调接口取数据了。
优化器是在说怎么取比较快。
但是能不能取是在分析器做的事情。
```

