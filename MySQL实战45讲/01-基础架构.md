## 一条SQL查询语句是如何执行的？

我们如果要查询 `select * from T where ID = 10`,从我们登陆到mysql服务器开始需要经过哪些步骤？

1. mysql -h$ip -P$port -u$user -p 连接到mysql服务器
   -  命令中的mysql是**客户端工具**，客户端工具的作用是用来和服务端建立连接，TCP三次握手后，就需要验证你的身份，负责验证身份的模块就是**连接器**
   - 如果验证用户名密码不对，会返回 “Access denied for user”的异常，然后客户端退出运行
   - 如果验证通过，还需要验证一个**权限**的东西，具体的用户都有一个自己的增删改查的权限，这个权限是记录在服务器中**权限表**的，**这个权限是连接的时候返回的，如果用管理员账号对这个用户的权限进行修改，只有退出重连才能生效**
   - 如果连接之后，没有任何操作，那这个连接的状态就是“Sleep”
   - 空闲不断开的时间受参数控制，一旦超过这个参数配置的时间，在使用这个连接，会报错，并提示你重新连接。
   - **长连接**指的是连接成功后，如果客户端有请求的，则一直使用同一个连接。短连接是指每几次查询就断开连接。这里不想探讨长连接有哪些好处，只想猜一下为什么有短连接这个选择，应该是一般的长连接空闲时间较长，而我们配置的超时时间比较长，导致数据库连接数被占满，从而导致不可用，而使用了短连接，但是短连接会频繁的进行tcp握手，这个占时还是比较长的[^ 作者按1]；而且建立连接的过程通常比较复杂[^作者按2]。
   - 长连接是一个对象，查询时使用的临时内存是管理在这个连接对象内的。这些会在连接断开的时候才释放，这导致了如果全是长连接的话内存占用过大，OOM，mysql重启了，解决思路有两个
     - 定时断开： 
       - 定期断
       - 程序检测到一个占用内存较大的查询的时候，断
     - 释放资源：
       - 把连接恢复到刚建立的时候
       - MySQL 5.7及以上
       - 执行 mysql_reset_connection

2. 连接成功后，会去

[^ 作者按1]: 具体的耗时占比我之前看过一个博文，可以使用抓包工具进行分析。
[^作者按2]: 怎么个复杂法，以后有时间可以研究一下