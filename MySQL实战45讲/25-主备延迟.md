#### 前言

我们在上一章高可用中知道，高可用=主备延迟低，延迟越低，就越可用。同时也知道了经常造成主备延迟的一些原因，本文对这些原因进行细化。

通读本文后，知道了本文其实就是在解决我在高可用一文中提出的生产者消费者问题，因为这二者的操作内容是不一致的，时间并不可以完全等价，实际上消费可能更快一些。本文的知识点非常多，今天对一些背景和之前的疑惑进行梳理。



#### 疑问的梳理

##### 主备延迟的根本原因

![img](https://static001.geekbang.org/resource/image/1a/ef/1a85a3bac30a32438bfd8862e5a34eef.png)

我们在主备一章中描述了这样一副图，图中的两个黑色箭头表示并发度。

正如图中描述的那样，其实主库写盘的并发度是远远高于备库消费的能力的。

如果主库的压力不大，因为备库一直在消费，所以这主备延迟还有缩小的可能，但是如果主库的压力一直很大，那么备库的延迟就会一直增加。



影响主库写日志的就是各种锁，但是除了那种热点数据会造成锁而阻塞并发度以外，大部分的锁基本不影响并发度。



5.6之前备库的复制是单线程的，当主库压力变大的情况下，主备的延迟会持续升高。



##### 备库的多线程复制

类似于线程池，每个需要执行的binlog语句都是一个一个任务，线程池中有个工作线程队列，这个工作线程的数目是由参数指定的。

但是和传统的多线程不同的是，这个取任务是有限制的。

